<!DOCTYPE html>
<html>

<head>
    <title>Lightning Map</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="shortcut icon" type="image/x-icon" href="/resources/images/favicon.png" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js" integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og==" crossorigin=""></script>

    <style>
            html,
            body,
            #map {
                margin: 0;
                padding: 0;
                width: 100%;
                height: 100%;
                background-color: #A0C7E0;
            }

            .leaflet-tooltip {
                background: rgba(42, 42, 42, 0.95);
                border-radius: 0;
                border: 0;
                color: #fff;
                font-weight: bold;
                font-size: 1.2em;
                padding: 10px;
                white-space: nowrap;
            }

            .leaflet-tooltip-top:before {
                border-top-color: rgba(42, 42, 42, 0.95);
                bottom: 0;
                margin-bottom: -12px;
            }
    </style>

</head>

<body>

    <div id="map"></div>

    <script>

        let numberOfMinutes = 30;
        let map = L.map("map");

        map.setView([50, 5], 5);

        document.title = numberOfMinutes + " minutes of European lightning strikes";

        // Basemap
        let url = 'http://donotbeonfire.co.uk:8080/styles/klokantech-terrain/{z}/{x}/{y}.jpeg';
        L.tileLayer(url, {
            attribution: 'OSM',
            maxZoom: 14
        }).addTo(map);

        var negativeIcon = L.icon({
            iconUrl: 'black_cross.svg',
            iconSize:     [20, 20], // size of the icon
            iconAnchor:   [10, 10], // point of the icon which will correspond to marker's location
            popupAnchor:  [10, 20] // point from which the popup should open relative to the iconAnchor
        });

        var positiveIcon = L.icon({
            iconUrl: 'red_cross.svg',
            iconSize:     [20, 20], // size of the icon
            iconAnchor:   [10, 10], // point of the icon which will correspond to marker's location
            popupAnchor:  [10, 20] // point from which the popup should open relative to the iconAnchor
        });

        // Get data from API via proxy
        var xhr = new XMLHttpRequest(),
            meteomaticsProxy = "https://betatest.metoffice.gov.uk/enthusiast/api/proxy";

        xhr.open("GET", meteomaticsProxy + "/get_lightning_list?time_range=now-" + numberOfMinutes + "M--now&bounding_box=60,-10_40,20&format=json", true);
        xhr.onload = function() {
            var data = JSON.parse(xhr.responseText);
            handleData(data);
        };
        xhr.send("");

        // On success, do something useful with the data
        function handleData (values) {

            var negativeChargeCount = 0,
                positiveChargeCount = 0,
                maximumCurrent = 0,
                maximumCurrentCharge = 0,
                marker,
                factor = numberOfMinutes * 60 * 1000,
                nowDate = new Date(values.dateGenerated),
                nowEpoch = nowDate.getTime(),
                strikeDate,
                strikeEpoch,
                ageOpacity;

            values.lightning_list.forEach(function(element) {

                strikeDate = new Date(element["stroke_time:sql"]),
                strikeEpoch = strikeDate.getTime();
                ageOpacity = (100/factor * (nowEpoch - strikeEpoch)) / 100;

                if (Number(element["stroke_current:kA"]) < 0) {
                    marker = L.marker([element["stroke_lat:d"], element["stroke_lon:d"]], {icon: negativeIcon, opacity: ageOpacity});
                    marker.bindTooltip("Negative Strike<br>Current: " + (Math.abs(Number(element["stroke_current:kA"])) * 1000) + " Amps<br>Time: " + element["stroke_time:sql"], {
                        direction: "top",
                        offset: L.point(0, -21)
                    });
                    negativeChargeCount = negativeChargeCount + 1;
                } else {
                    marker = L.marker([element["stroke_lat:d"], element["stroke_lon:d"]], {icon: positiveIcon, opacity: ageOpacity});
                    marker.bindTooltip("Positive Strike<br>Current: " + (Math.abs(Number(element["stroke_current:kA"])) * 1000) + " Amps<br>Time: " + element["stroke_time:sql"], {
                        direction: "top",
                        offset: L.point(0, -21)
                    });
                    positiveChargeCount = positiveChargeCount + 1;
                }

                marker.addTo(map);

                if (Math.abs(Number(element["stroke_current:kA"])) > maximumCurrent) {

                    maximumCurrent = Math.abs(Number(element["stroke_current:kA"]));

                    if (Number(element["stroke_current:kA"]) < 0) {
                        maximumCurrentCharge = "-ve";
                    } else {
                        maximumCurrentCharge = "+ve";
                    }

                }

            });

            console.log("Total count :        ", negativeChargeCount + positiveChargeCount, "\n-ve count :          ", negativeChargeCount, "\n+ve count :          ", positiveChargeCount, "\nMax current :        ", maximumCurrent * 1000 + " Amps", "\nMax current charge : ", maximumCurrentCharge)

        }

    </script>

</body>

</html>