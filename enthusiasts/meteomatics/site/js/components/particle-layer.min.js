"use strict";window.metoffice=window.metoffice||{},window.metoffice.enthusiast=window.metoffice.enthusiast||{},window.metoffice.enthusiast.particleLayer=function(){var e,i,t,n,o,a,s,r,c=!1,d=function(){f(),window.clearTimeout(r),r=window.setTimeout(function(){void 0===n.secondary||!0!==n.secondary||c||u()},1e3)},f=function(){try{e.eachLayer(function(i){void 0!==i.options.type&&"particleLayer"===i.options.type&&(i._windy.stop(),e.removeLayer(i))})}catch(e){console.log("Error clearing particle layer : ",e.message)}},u=function(){var r,d,u,w,m="",v="",p=1,y=85,h=-85,E=-180,D=180,g={},A={},T={},_=[];r=i.paths.pathAPI,void 0!==t[o.id]&&(m="&run="+t[o.id]),void 0===o.downsampling||o.downsampling||(v="&interp_select=none"),u=(d=r+"/"+new Date(s).toISOString()+"/{layer}"+a+":"+n.parameter.units[0]+"/"+y+","+E+"_"+h+","+D+":"+p+","+p+"/csv?model="+o.id+m+v).replace("{layer}","wind_speed_u_"),w=d.replace("{layer}","wind_speed_v_"),d3.text(u,function(i,t){i?console.log("Error loading API data"):d3.text(w,function(i,o){i?console.log("Error loading API data"):(T.la1=y,T.la2=h,T.lo1=E,T.lo2=D,T.dx=p,T.dy=p,T.nx=(T.lo2-T.lo1)*(1/T.dx)+1,T.ny=(T.la1-T.la2)*(1/T.dy)+1,g.header=JSON.parse(JSON.stringify(T)),g.header.parameterCategory=2,g.header.parameterNumber=2,g.data=l(t),_.push(g),A.header=JSON.parse(JSON.stringify(T)),A.header.parameterCategory=2,A.header.parameterNumber=3,A.data=l(o),_.push(A),f(),void 0===n.secondary||!0!==n.secondary||c||L.velocityLayer({type:"particleLayer",displayValues:!1,velocityScale:.005,colorScale:["#FFFFFF"],particleAge:80,lineWidth:1,particleMultiplier:.001}).addTo(e).setData(_))})})},l=function(e){var i,t,n,o=[];if(void 0!==e){for(t=e.split("\n").slice(3),n=0;n<t.length-1;n++)(i=t[n].split(";")).shift(),o=o.concat(i);return o}};return{init:function(){window.metoffice.eventBus.subscribeToEvent(window.metoffice.enthusiast.eventDefinitions.CONFIGURATION_LOADED,function(e){i=e}),window.metoffice.eventBus.subscribeToEvent(window.metoffice.enthusiast.eventDefinitions.LATEST_RUNS_LOADED,function(e){t=e}),window.metoffice.eventBus.subscribeToEvent(window.metoffice.enthusiast.eventDefinitions.MAP_READY,function(i){e=i}),window.metoffice.eventBus.subscribeToEvent(window.metoffice.enthusiast.eventDefinitions.LAYER_CHANGED,function(e){o=e.modelConfig,n=e.layerConfig}),window.metoffice.eventBus.subscribeToEvent(window.metoffice.enthusiast.eventDefinitions.ALTITUDE_CHANGED,function(e){a=e}),window.metoffice.eventBus.subscribeToEvent(window.metoffice.enthusiast.eventDefinitions.TIMELINE_CHANGED,function(i){var t=e.timeDimension.getAvailableTimes();s=t[i.timestepIndex],d()}),window.metoffice.eventBus.subscribeToEvent(window.metoffice.enthusiast.eventDefinitions.TIMELINE_ANIMATING_CHANGED,function(e){c=e.isPlaying,d()})}}}(),window.addEventListener("DOMContentLoaded",window.metoffice.enthusiast.particleLayer.init);