"use strict";window.metoffice=window.metoffice||{},window.metoffice.enthusiast=window.metoffice.enthusiast||{},window.metoffice.enthusiast.wmtsLayer=function(){var e,i,t,n,s,o,a,r=function(s){e.timeDimension=m(s),window.metoffice.eventBus.notifyEventSubscribers(window.metoffice.enthusiast.eventDefinitions.TIME_DIMENSION_CHANGED,{currentTime:e.timeDimension.getCurrentTime(),currentTimeIndex:e.timeDimension.getCurrentTimeIndex(),period:e.timeDimension.options.period,timeSteps:e.timeDimension.getAvailableTimes(),defaultTimeStep:s.time.default}),e.hasLayer(i)&&e.removeLayer(i),(i=d(e,t,s,o,n)).addTo(e)},m=function(e){var i,t,n,s;return i=new Date,e.time.delay&&(s=1e3*window.nezasa.iso8601.Period.parseToTotalSeconds(e.time.delay),i=new Date(i.getTime()-s)),s=1e3*window.nezasa.iso8601.Period.parseToTotalSeconds(e.time.step),t=new Date(i.getTime()-i.getTime()%s),(n="first"===e.time.default?new L.TimeDimension({timeInterval:t.toISOString()+"/"+e.time.period,period:e.time.step,currentTime:t}):new L.TimeDimension({timeInterval:e.time.period+"/"+t.toISOString(),period:e.time.step,currentTime:t})).on("timeload",function(e){e.target.prepareNextTimes(1,o.preloadCount,!0)}),n},d=function(e,i,t,n,s){var o,r,m={};return m={service:"WMTS",version:"1.0.0",request:"GetTile",style:t.style,uppercase:!0,zIndex:300,updateWhenIdle:!0,updateWhenZooming:!1},t.parameter.interval?m.layer=n.id+":"+t.parameter.name+"_"+t.parameter.interval+":"+t.parameter.units[0]:t.parameter.vertical?m.layer=n.id+":"+t.parameter.name+"_"+a+":"+t.parameter.units[0]:m.layer=n.id+":"+t.parameter.name+":"+t.parameter.units[0],m.format="image/"+t.format,void 0!==s[n.id]&&(m.run=s[n.id]),L.TileLayer.WMTS=L.TileLayer.WMS.extend({getTileUrl:function(e){return delete this.wmsParams.layers,delete this.wmsParams.styles,delete this.wmsParams.transparent,delete this.wmsParams.width,delete this.wmsParams.height,this.wmsParams.tilematrixset="webmercator",this.wmsParams.tilematrix=e.z,this.wmsParams.tilecol=e.x,this.wmsParams.tilerow=e.y,this._url+L.Util.getParamString(this.wmsParams,this._url,this.options.uppercase)}}),o=new L.TileLayer.WMTS(i.paths.pathWMTS,m),(r=L.timeDimension.layer.wms(o,{getCapabilitiesUrl:"getcapabilities.xml"})).on("timeload",function(i){e.timeDimension.prepareNextTimes(1,n.preloadCount,!0)}),r};return{init:function(){window.metoffice.eventBus.subscribeToEvent(window.metoffice.enthusiast.eventDefinitions.CONFIGURATION_LOADED,function(e){t=e}),window.metoffice.eventBus.subscribeToEvent(window.metoffice.enthusiast.eventDefinitions.LATEST_RUNS_LOADED,function(e){n=e}),window.metoffice.eventBus.subscribeToEvent(window.metoffice.enthusiast.eventDefinitions.MAP_READY,function(i){e=i}),window.metoffice.eventBus.subscribeToEvent(window.metoffice.enthusiast.eventDefinitions.LAYER_CHANGED,function(e){o=e.modelConfig,void 0===(s=e.layerConfig).parameter.vertical&&r(s)}),window.metoffice.eventBus.subscribeToEvent(window.metoffice.enthusiast.eventDefinitions.ALTITUDE_CHANGED,function(e){a=e,r(s)}),window.metoffice.eventBus.subscribeToEvent(window.metoffice.enthusiast.eventDefinitions.TIMELINE_CHANGED,function(i){var t=e.timeDimension.getAvailableTimes();i.isRewindingWhilePlaying?e.timeDimension.setCurrentTime(t[0]):e.timeDimension.setCurrentTime(t[i.timestepIndex])})}}}(),window.addEventListener("DOMContentLoaded",window.metoffice.enthusiast.wmtsLayer.init);