"use strict";window.metoffice=window.metoffice||{},window.metoffice.enthusiast=window.metoffice.enthusiast||{},window.metoffice.enthusiast.popup=function(){var e,t,n,i,o,s,f,p,u,a,c,d=function(){t=L.responsivePopup({closeButton:!1,closeOnClick:!1,autoPanPaddingTopLeft:i.map.offsets.leftTop,autoPanPaddingBottomRight:i.map.offsets.rightBottom})},w=function(n){t.isOpen()?e.closePopup():(t.setLatLng(n),r(),window.metoffice.eventBus.notifyEventSubscribers(window.metoffice.enthusiast.eventDefinitions.MAP_POPUP_SHOWN))},r=function(){v(e.wrapLatLng(u),o,function(i){n=l(n,i),t.setContent(n),t.isOpen()||t.openOn(e)})},v=function(e,t,n){var o,u,a,d=new window.XMLHttpRequest;for(o=(o=i.paths.pathAPI)+"/"+new Date(c[0]).toISOString()+"--"+new Date(c[c.length-1]).toISOString()+":"+f.time.step+"/",a=0;a<f.popup.length;a++)void 0!==f.popup[a].parameter&&(o+=f.popup[a].parameter,void 0!==f.popup[a].interval&&(o=o+"_"+f.popup[a].interval),void 0!==p&&(o=o+"_"+p),o=o+":"+f.popup[a].units[0],a<f.popup.length-1&&(o+=","));o=(o=(o=o+"/"+e.lat.toFixed(4))+","+e.lng.toFixed(4))+"/json?model="+s.id,void 0!==t[s.id]&&(o=o+"&run="+t[s.id]),s.downsampling||(o+="&interp_select=none"),d.open("GET",o),d.onload=function(){200!==d.status&&console.error("Error loading API data",d.responseText),u=JSON.parse(d.responseText),"function"==typeof n&&n(u)},d.send()},l=function(e,t){var n,o,s=0;if("ERROR"!==t.status)for(e="",void 0===f.popup[0].parameter&&(e+='<div class="leaflet-popup-content">'+f.popup[0].label+"</div>",s+=1),n=0;n<t.data.length;n++)o=t.data[n].coordinates[0].dates[a].value,o=m(o,i.units[f.popup[n+s].units[0]]),e+='<div class="leaflet-popup-content">'+f.popup[n+s].label+"<br><span>"+o+"</span></div>";else e='<div class="leaflet-popup-content">No data</div>';return e},m=function(e,t){return e=-999===e||-888===e||-777===e?"No data":-666===e?"Not<br>applicable to<br>this location":e+" "+t};return{init:function(){window.metoffice.eventBus.subscribeToEvent(window.metoffice.enthusiast.eventDefinitions.CONFIGURATION_LOADED,function(e){i=e}),window.metoffice.eventBus.subscribeToEvent(window.metoffice.enthusiast.eventDefinitions.LATEST_RUNS_LOADED,function(e){o=e}),window.metoffice.eventBus.subscribeToEvent(window.metoffice.enthusiast.eventDefinitions.MAP_READY,function(t){e=t,d()}),window.metoffice.eventBus.subscribeToEvent(window.metoffice.enthusiast.eventDefinitions.LAYER_CHANGED,function(e){s=e.modelConfig,void 0===(f=e.layerConfig).parameter.vertical&&(p=void 0)}),window.metoffice.eventBus.subscribeToEvent(window.metoffice.enthusiast.eventDefinitions.ALTITUDE_CHANGED,function(e){p=e}),window.metoffice.eventBus.subscribeToEvent(window.metoffice.enthusiast.eventDefinitions.TIME_DIMENSION_CHANGED,function(e){c=e.timeSteps}),window.metoffice.eventBus.subscribeToEvent(window.metoffice.enthusiast.eventDefinitions.TIMELINE_CHANGED,function(e){a=Math.abs(e.timestepIndex),t.isOpen()&&r()}),window.metoffice.eventBus.subscribeToEvent(window.metoffice.enthusiast.eventDefinitions.MAP_CLICKED,function(e){w(u=e)})}}}(),window.addEventListener("DOMContentLoaded",window.metoffice.enthusiast.popup.init);