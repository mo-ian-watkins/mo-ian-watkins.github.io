"use strict";window.metoffice=window.metoffice||{},window.metoffice.enthusiast=window.metoffice.enthusiast||{},window.metoffice.enthusiast.wmtsLayer=function(){var e,i,t,n,o,s,a,r=function(o){e.timeDimension=m(o),window.metoffice.eventBus.notifyEventSubscribers(window.metoffice.enthusiast.eventDefinitions.TIME_DIMENSION_CHANGED,{currentTime:e.timeDimension.getCurrentTime(),currentTimeIndex:e.timeDimension.getCurrentTimeIndex(),period:e.timeDimension.options.period,timeSteps:e.timeDimension.getAvailableTimes(),defaultTimeStep:o.time.default}),e.hasLayer(i)&&e.removeLayer(i),(i=d(e,t,o,s,n)).addTo(e)},m=function(e){var i,t,n;return i=new Date,e.time.delay&&(n=1e3*window.nezasa.iso8601.Period.parseToTotalSeconds(e.time.delay),i=new Date(i.getTime()-n)),n=1e3*window.nezasa.iso8601.Period.parseToTotalSeconds(e.time.step),t=new Date(i.getTime()-i.getTime()%n),"first"===e.time.default?new L.TimeDimension({timeInterval:t.toISOString()+"/"+e.time.period,period:e.time.step,currentTime:t}):new L.TimeDimension({timeInterval:e.time.period+"/"+t.toISOString(),period:e.time.step,currentTime:t})},d=function(e,i,n,o,s){var r,m,d={};return d={service:"WMS",version:"1.3.0",request:"GetMap",format:"image/png",transparent:!0,styles:n.style,zIndex:300,pane:"tilePane"},n.parameter.interval?d.layers=o.id+":"+n.parameter.name+"_"+n.parameter.interval+":"+n.parameter.units[0]:n.parameter.vertical?d.layers=o.id+":"+n.parameter.name+"_"+a+":"+n.parameter.units[0]:d.layers=o.id+":"+n.parameter.name+":"+n.parameter.units[0],void 0!==s[o.id]&&(d.run=s[o.id]),"WMS"===o.type?(e.setMaxBounds(L.latLngBounds(t.map.bounds.wms)),d.bounds=L.latLngBounds(o.bounds),L.Layer.WMS=L.NonTiledLayer.WMS.extend({getImageUrl:function(i,t,n){var o,s=this.wmsParams,a=this._crs.project(i.getNorthWest()),r=this._crs.project(i.getSouthEast()),m=this._wmsUrl;return e.getBounds().overlaps(i)?(s.width=Math.round(t),s.height=Math.round(n),o=(this._wmsVersion>=1.3&&this._crs===L.CRS.EPSG4326?[r.y,a.x,a.y,r.x]:[a.x,r.y,r.x,a.y]).join(","),m+L.Util.getParamString(this.wmsParams,m,this.options.uppercase)+(this.options.uppercase?"&BBOX=":"&bbox=")+o):this.options.errorImageUrl}}),r=new L.Layer.WMS(i.paths.pathAPI+"/wms",d)):(e.setMaxBounds(L.latLngBounds(t.map.bounds.max)),d.tileSize=512,d.updateWhenIdle=!0,d.updateWhenZooming=!1,o.downsampling||(d.interp_select="none"),r=L.tileLayer.wms(i.paths.pathAPI+"/wms",d)),(m=L.timeDimension.layer.wms(r,{getCapabilitiesUrl:"getcapabilities.xml"})).once("timeload",function(i){e.timeDimension.prepareNextTimes(0,o.preloadCount-1,!0),e.timeDimension.on("timeload",function(e){e.target.prepareNextTimes(0,o.preloadCount-1,!0)})}),m};return{init:function(){window.metoffice.eventBus.subscribeToEvent(window.metoffice.enthusiast.eventDefinitions.CONFIGURATION_LOADED,function(e){t=e}),window.metoffice.eventBus.subscribeToEvent(window.metoffice.enthusiast.eventDefinitions.LATEST_RUNS_LOADED,function(e){n=e}),window.metoffice.eventBus.subscribeToEvent(window.metoffice.enthusiast.eventDefinitions.MAP_READY,function(i){e=i}),window.metoffice.eventBus.subscribeToEvent(window.metoffice.enthusiast.eventDefinitions.LAYER_CHANGED,function(e){s=e.modelConfig,void 0===(o=e.layerConfig).parameter.vertical&&r(o)}),window.metoffice.eventBus.subscribeToEvent(window.metoffice.enthusiast.eventDefinitions.ALTITUDE_CHANGED,function(e){a=e,r(o)}),window.metoffice.eventBus.subscribeToEvent(window.metoffice.enthusiast.eventDefinitions.TIMELINE_CHANGED,function(i){var t=e.timeDimension.getAvailableTimes();i.isRewindingWhilePlaying?e.timeDimension.setCurrentTime(t[0]):e.timeDimension.setCurrentTime(t[i.timestepIndex])})}}}(),window.addEventListener("DOMContentLoaded",window.metoffice.enthusiast.wmtsLayer.init);