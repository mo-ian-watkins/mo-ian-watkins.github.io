"use strict";window.metoffice=window.metoffice||{},window.metoffice.enthusiast=window.metoffice.enthusiast||{},window.metoffice.enthusiast.key=function(){var e,t,n,r,a,i,o=!0,l=function(){var t=s(),n=e.getContainer();void 0!==n&&n.appendChild(t)},s=function(){var e=window.metoffice.uiFactory.createStandardButtonElement("key-button","","button--black button--key",!1);return(i=document.createElement("span")).setAttribute("class","icon icon--key"),i.setAttribute("id","key-button-icon"),e.appendChild(i),e.addEventListener("click",c),e},c=function(){(o=!o)?u():d()},u=function(){document.getElementById("key-container").classList.remove("hidden"),i.classList.remove("icon--key"),i.classList.add("icon--chevron-white")},d=function(){document.getElementById("key-container").classList.add("hidden"),i.classList.add("icon--key"),i.classList.remove("icon--chevron-white")},m=function(e,t,n,r,a){void 0!==e.getContainer()&&p(n,t,r,a,function(e){"continuous"===n.key.type?y(n,e):"ordinal"===n.key.type&&h(n,e)})},p=function(e,t,n,r,a){var i,o,l,s,c=new window.XMLHttpRequest;o=t.paths.pathAPI+"/get_colormap?format=csv&parameter=",l=e.key.scaling&&"m"===e.parameter.units[0]?"km":e.parameter.units[0],e.parameter.vertical&&(s=void 0!==r?r:e.parameter.vertical[0]),o=(o=e.parameter.interval?o+n.id+":"+e.parameter.name+"_"+e.parameter.interval+":"+l:e.parameter.vertical?o+n.id+":"+e.parameter.name+"_"+s+":"+l:o+n.id+":"+e.parameter.name+":"+l)+"&style="+e.style,c.open("GET",o),c.onload=function(){200!==c.status?console.error("Error loading API data",c.responseText):(i=c.responseText,"function"==typeof a&&a(i))},c.send()},f=function(e){return e.parameter.interval?t.units[e.parameter.units[0]]+" / <br>"+e.parameter.interval:t.units[e.parameter.units[0]]},y=function(e,t){var n,r,a,i,o,l,s,c;(n=d3.select("#key")).selectAll("*").remove(),parseInt(n.style("width")),r=window.innerHeight-.7*window.innerHeight,document.getElementById("key").style.height=r+"px",t=t.replace(/FF\n/g,"\n"),t=d3.dsvFormat(";").parse(t,function(t){return t.Value=Number(t.Value),e.key.scaling&&"m"===e.parameter.units[0]&&(t.Value=Number(t.Value)*e.key.scaling),{value:t.Value,color:t["Hex Color"]}}),o=f(e),a=d3.extent(t,function(e){return e.value}),i=r-24,document.getElementById("key-label-container").innerHTML=o,l=d3.scaleLinear().range([i,0]).domain(a),s=d3.axisRight(l).tickSize(16).ticks(6),c=n.append("g").attr("transform","translate(0, 12)"),n.append("defs").append("linearGradient").attr("id","myGradient").attr("x1","0%").attr("y1","0%").attr("x2","0%").attr("y2","100%").selectAll("stop").data(t).enter().append("stop").attr("offset",function(e){return(e.value-a[1])/(a[0]-a[1])*100+"%"}).attr("stop-color",function(e){return e.color}),c.append("rect").attr("width",12).attr("height",i).style("fill","url(#myGradient)"),c.append("g").attr("class","key-axis").call(s).select(".domain").remove()},h=function(e,t){var n,r,a,i,o,l,s,c,u,d,m=[],p=[],y=[];if((n=d3.select("#key")).selectAll("*").remove(),parseInt(n.style("width")),i=window.innerHeight-.7*window.innerHeight,document.getElementById("key").style.height=i+"px",t=t.replace(/FF\n/g,"\n"),t=d3.dsvFormat(";").parse(t,function(t){return t.Value=Number(t.Value),e.key.scaling&&"m"===e.parameter.units[0]&&(t.Value=Number(t.Value)*e.key.scaling),{value:Number(t.Value),color:t["Hex Color"]}}),void 0!==e.key.minimum){for(y=[],a=0;a<t.length;a++)Number(t[a].value)>=e.key.minimum&&y.push(t[a]);t=y}if(void 0!==e.key.maximum){for(y=[],a=0;a<t.length;a++)Number(t[a].value)<=e.key.maximum&&y.push(t[a]);t=y}for(r=JSON.parse(JSON.stringify(e.key.ticks)),a=0;a<t.length;a++)m.push(t[a].color);for((m=m.filter(function(e,t,n){return n.indexOf(e)===t})).reverse(),l=f(e),o=i-24,a=0;a<m.length;a++)p.push(o/m.length*a);document.getElementById("key-label-container").innerHTML=l,d=n.append("g").attr("transform","translate(0, 12)"),m.reverse(),s=d3.scaleOrdinal().domain(p).range(m),d.selectAll("rect").data(p).enter().append("rect").attr("x",function(e){return 0}).attr("y",function(e){return e}).attr("height",function(e){return o/m.length}).attr("width",function(e){return 12}).attr("fill",function(e){return s(e)}),p.push(p[m.length-1]+o/m.length),r.reverse(),c=d3.scaleOrdinal().domain(r).range(p),u=d3.axisRight(c).tickSize(16).tickFormat(d3.format(",.1r")),d.append("g").attr("class","key-axis").call(u).select(".domain").remove()};return{init:function(){window.metoffice.eventBus.subscribeToEvent(window.metoffice.enthusiast.eventDefinitions.KEY_DETAILS_READY,function(i){e=i.control,t=i.configuration,n=i.currentLayer,r=i.currentModel,a=i.currentAltitude,l(),m(e,t,n,r,a),!0===o&&u()})}}}(),window.addEventListener("DOMContentLoaded",window.metoffice.enthusiast.key.init);